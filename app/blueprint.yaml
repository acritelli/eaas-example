tosca_definitions_version: cloudify_dsl_1_3


imports:
  - https://cloudify.co/spec/cloudify/6.0.0/types.yaml


inputs:
  resource_suffix:
    type: string


labels:
  csys-obj-type:
    values:
      - service
  csys-obj-parent:
    values:
      - infra


node_templates:

  pv:
    type: cloudify.kubernetes.resources.PersistentVolume
    properties:
      definition:
        apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: { concat: [ 'wp-pv-', { get_input: resource_suffix } ] }
          labels:
            type: local
        spec:
          capacity:
            storage: 20Gi
          accessModes:
            - ReadWriteOnce
          hostPath:
            path: { concat: [ '/tmp/data/wp-pv-', { get_input: resource_suffix } ] }
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: master

  pv-claim:
    type: cloudify.kubernetes.resources.PersistentVolumeClaim
    properties:
      definition:
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: { concat: [  'wp-pv-claim-', { get_input: resource_suffix } ] }
          labels:
            app:  { concat: [  'wordpress-',  { get_input: resource_suffix } ] }
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi
          selector:
            matchLabels:
              type: "local"
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: master
      - type: cloudify.relationships.depends_on
        target: pv

  service:
    type: cloudify.kubernetes.resources.Service
    properties:
      definition:
        apiVersion: v1
        kind: Service
        metadata:
          name: wordpress
          labels:
            app: wordpress
        spec:
          ports:
            - port: 80
              nodePort: 30080
          selector:
            app: wordpress
            tier: frontend
          type: LoadBalancer
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: master
      - type: cloudify.relationships.depends_on
        target: pv-claim

  deploy:
    type: cloudify.kubernetes.resources.Deployment
    properties:
      definition:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: { concat:  [  'wordpress-', { get_input: resource_suffix } ] }
          labels:
            app: { concat: [  'wordpress-', { get_input: resource_suffix } ] }
        spec:
          replicas: 3
          strategy:
            type: Recreate
          selector:
            matchLabels:
                app: { concat: [  'wordpress-', { get_input: resource_suffix } ] }
                tier: frontend
          template:
            metadata:
              labels:
                app: { concat: [  'wordpress-', { get_input: resource_suffix } ] }
                tier: frontend
            spec:
              replicas: 3
              containers:
              - image: wordpress:4.8.0-apache
                name: { concat: [  'wordpress-', { get_input: resource_suffix } ] }
                env:
                  - name: WORDPRESS_DB_HOST
                    value: { get_environment_capability: db_host }
                  - name: WORDPRESS_DB_USER
                    value: { get_environment_capability: db_master_username }
                  - name: WORDPRESS_DB_PASSWORD
                    value: { get_environment_capability: db_master_password }
                  - name: WORDPRESS_DB_NAME
                    value: { get_environment_capability: db_name }
                  - name: WORDPRESS_TABLE_PREFIX
                    value: cfy
                ports:
                  - containerPort: 80
                    name: { concat: [  'wordpress-', { get_input: resource_suffix } ] }
                volumeMounts:
                  - name:  { concat: [  'wordpress-persistent-storage-', { get_input: resource_suffix } ] }
                    mountPath: /var/www/html
              volumes:
                - name:  { concat: [  'wordpress-persistent-storage-', { get_input: resource_suffix } ] }
                  persistentVolumeClaim:
                    claimName: { concat: [  'wp-pv-claim-', { get_input: resource_suffix } ] }
              terminationGracePeriodSeconds: 5
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: master
      - type: cloudify.relationships.depends_on
        target: service

  master:
    type: cloudify.kubernetes.nodes.Master
    properties:
      configuration:
        file_content: { get_environment_capability: k8s_kubeconf }


capabilities:
  wordpress:
    value: { get_attribute: [ deploy, kubernetes, status, load_balancer, ingress, 0, ip ] }